/**
 * @file os_tlb.c
 * @brief TLB (Translation Lookaside Buffer) functions
 *
 * Decompiled from asm/us/E440.s, E490.s
 * Contains functions for TLB management on the MIPS R4300i.
 *
 * TLB functions are implemented in assembly because they require
 * direct access to CP0 registers and TLB instructions (tlbwi, tlbr, etc.)
 * which cannot be generated by standard C compilers.
 */

#include "types.h"

/**
 * Initialize TLB entries
 * (func_8000D890 - __osTlbInit)
 *
 * Sets up initial TLB mappings for the system.
 * This creates a mapping for the KUSEG address space.
 *
 * CP0 registers used:
 * - $10 (EntryHi): Virtual page number and ASID
 * - $0 (Index): TLB entry index
 * - $5 (PageMask): Page size mask
 * - $2 (EntryLo0): Physical page frame 0
 * - $3 (EntryLo1): Physical page frame 1
 *
 * TLB Entry created:
 * - Index 0
 * - PageMask: 0 (4KB pages)
 * - EntryHi: 0xC0000000 (KUSEG virtual address)
 * - EntryLo0: 0x80000000 >> 6 | 0x17 (physical page, valid, dirty, global)
 * - EntryLo1: 0x01 (invalid)
 *
 * Assembly (must be handwritten):
 *   mfc0 $t0, $10      ; Save EntryHi
 *   addiu $t1, $zero, 0x1F
 *   mtc0 $t1, $0       ; Index = 31
 *   mtc0 $zero, $5     ; PageMask = 0 (4KB)
 *   addiu $t2, $zero, 0x17
 *   lui $t1, 0xC000
 *   mtc0 $t1, $10      ; EntryHi = 0xC0000000
 *   lui $t1, 0x8000
 *   srl $t3, $t1, 6
 *   or $t3, $t3, $t2
 *   mtc0 $t3, $2       ; EntryLo0 = (0x80000000 >> 6) | 0x17
 *   addiu $t1, $zero, 1
 *   mtc0 $t1, $3       ; EntryLo1 = 1
 *   nop
 *   tlbwi              ; Write TLB entry
 *   nop (x4)
 *   mtc0 $t0, $10      ; Restore EntryHi
 *   jr $ra
 *
 * Note: Cannot implement in C - requires CP0 access and tlbwi instruction.
 */
void __osTlbInit(void);

/**
 * TLB Lookup function
 * (func_8000FCB0 - __osTLBLookup)
 *
 * Looks up a virtual address in the TLB to get the physical address.
 * Used by osVirtualToPhysical for KUSEG addresses that are not in
 * KSEG0/KSEG1 (direct-mapped segments).
 *
 * @param addr Virtual address to look up
 * @return Physical address, or 0 if not found
 *
 * Note: Cannot implement in C - requires tlbp (TLB probe) instruction.
 */
u32 __osTLBLookup(void *addr);

/**
 * Map TLB entry
 * (func_8000D440 - osTLBMapTLB)
 *
 * Creates a TLB mapping from a virtual address to physical address.
 *
 * @param index TLB entry index (0-31)
 * @param pageMask Page size mask
 * @param entryHi Virtual page number and ASID
 * @param entryLo0 Even page physical mapping
 * @param entryLo1 Odd page physical mapping
 */
void osTLBMapTLB(s32 index, u32 pageMask, u32 entryHi, u32 entryLo0, u32 entryLo1);

/**
 * Unmap TLB entry
 * (func_8000D4B0 - osTLBUnmapTLB)
 *
 * Invalidates a TLB entry.
 *
 * @param index TLB entry index to unmap
 */
void osTLBUnmapTLB(s32 index);
